<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cardano Staking</title>
</head>

<body>
  <p id="message">Loading CSL...</p>

  <!-- Disable ALL service workers (Fixes Yoroi issue) -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(regs => {
        for (let r of regs) {
          console.log("Unregistering SW:", r);
          r.unregister();
        }
      });
    }
  </script>

  <!-- Delay to ensure SW is removed -->
  <script>
    window.CSL_READY = new Promise(res => setTimeout(res, 300));
  </script>

  <!-- Load CSL manually -->
  <script type="module">
    import * as CSL from "./libs/cardano_serialization_lib.js";

    async function loadCSL() {
      await window.CSL_READY; // wait for SW unregister

      const wasmBytes = await fetch("./libs/cardano_serialization_lib_bg.wasm").then(r => r.arrayBuffer());
      const wasmInstance = await WebAssembly.instantiate(wasmBytes, {});
      CSL.__wbg_set_wasm(wasmInstance.instance.exports);

      window.Cardano = CSL;
      console.log("âœ… CSL Loaded after SW unregister");
      window.dispatchEvent(new Event("csl-loaded"));
    }

    loadCSL();
  </script>

  <script type="module" src="./main.js"></script>

</body>
</html>
